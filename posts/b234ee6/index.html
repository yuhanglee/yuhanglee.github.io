<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>RTT 启动顺序 | 博客</title><meta name=author content>
<meta name=description content=" 启动 启动是系统的第一个动作。 "><meta name=keywords content='draft'><meta itemprop=name content="RTT 启动顺序"><meta itemprop=description content="启动 启动是系统的第一个动作。"><meta itemprop=datePublished content="2024-06-04T20:50:07+08:00"><meta itemprop=dateModified content="2025-02-05T05:07:12+00:00"><meta itemprop=wordCount content="1356"><meta itemprop=image content="https://yuhanglee.github.io/images/apple-devices-preview.webp"><meta itemprop=keywords content="draft"><meta property="og:url" content="https://yuhanglee.github.io/posts/b234ee6/"><meta property="og:site_name" content="博客"><meta property="og:title" content="RTT 启动顺序"><meta property="og:description" content="启动 启动是系统的第一个动作。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-04T20:50:07+08:00"><meta property="article:modified_time" content="2025-02-05T05:07:12+00:00"><meta property="article:tag" content="draft"><meta property="og:image" content="https://yuhanglee.github.io/images/apple-devices-preview.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yuhanglee.github.io/images/apple-devices-preview.webp"><meta name=twitter:title content="RTT 启动顺序"><meta name=twitter:description content="启动 启动是系统的第一个动作。"><meta name=application-name content="以梦为马"><meta name=apple-mobile-web-app-title content="以梦为马"><meta name=theme-color data-light=#ffffff data-dark=#252627 content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical type=text/html href=https://yuhanglee.github.io/posts/b234ee6/ title="RTT 启动顺序 | 博客"><link rel=prev type=text/html href=https://yuhanglee.github.io/posts/hugo-start/ title="Hugo Start"><link rel=next type=text/html href=https://yuhanglee.github.io/posts/e3e350c/ title=zephyr教程-环境配置><link rel=alternate type=text/markdown href=https://yuhanglee.github.io/posts/b234ee6/index.md title="RTT 启动顺序 | 博客"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://unpkg.com/@fortawesome/fontawesome-free@6.7.1/css/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@6.7.1/css/all.min.css></noscript><link rel=preload href=https://unpkg.com/animate.css@4.1.1/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"RTT 启动顺序","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yuhanglee.github.io\/posts\/b234ee6\/"},"image":[{"@type":"ImageObject","url":"https:\/\/yuhanglee.github.io\/images\/apple-devices-preview.webp","width":2880,"height":1508}],"genre":"posts","keywords":"draft","wordcount":1356,"url":"https:\/\/yuhanglee.github.io\/posts\/b234ee6\/","datePublished":"2024-06-04T20:50:07+08:00","dateModified":"2025-02-05T05:07:12+00:00","license":"本站内容采用 CC BY-NC-SA 4.0 国际许可协议。","publisher":{"@type":"Organization","name":"Lruihao","logo":"https:\/\/yuhanglee.github.io\/images\/avatar.jpg"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title=博客><img loading=lazy src=/logo.webp alt=博客 data-title=博客 width=26 height=26 class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>菠菜众长</span></a><span class=header-subtitle>博客</span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/archives/><i class="fa-solid fa-feather fa-fw fa-sm" aria-hidden=true></i> 文章</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users-viewfinder fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-regular fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class="menu-item has-children"><a class=menu-link href=/about/><i class="fa-solid fa-quote-left fa-fw fa-sm" aria-hidden=true></i> 关于</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/projects/ title=我的作品集><i class="fa-solid fa-laptop-code fa-fw fa-sm" aria-hidden=true></i> 我的作品</a></li></ul></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=博客><img loading=lazy src=/logo.webp alt=博客 data-title=博客 width=26 height=26 class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>菠菜众长</span></a><span class=header-subtitle>博客</span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/archives/><i class="fa-solid fa-feather fa-fw fa-sm" aria-hidden=true></i> 文章</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users-viewfinder fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-regular fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/about/><i class="fa-solid fa-quote-left fa-fw fa-sm" aria-hidden=true></i> 关于</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/projects/ title=我的作品集><i class="fa-solid fa-laptop-code fa-fw fa-sm" aria-hidden=true></i> 我的作品</a></li></ul></li><li class="menu-item text-center"><a class=menu-link href=https://github.com/Lruihao/hugo-blog title=GitHub rel="noopener noreferrer" target=_blank><i class="fa-brands fa-github fa-lg fa-fw fa-sm" aria-hidden=true></i> 关注 Follow</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item data-separator=/><a href=/posts/ title=Posts>文章</a></li><li class="breadcrumb-item active" data-separator=/ aria-current=page>RTT 启动顺序</li></ol></nav><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>RTT 启动顺序</span></h1><p class="single-subtitle animate__animated animate__fadeIn">启动顺序</p></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
Anonymous</span></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/draft/ class=post-category title="分类 - draft"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> draft</a></span></div><div class=post-meta-line><span title="发布于 2024-06-04 20:50:07"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-06-04>2024-06-04</time></span>&nbsp;<span title="更新于 2025-02-05 05:07:12"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2025-02-05>2025-02-05</time></span>&nbsp;<span title="1356 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 1400 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 3 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="RTT 启动顺序"><i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#切换上下文>切换上下文</a><ol><li><a href=#csa>CSA</a></li><li><a href=#切换上下文-1>切换上下文</a></li></ol></li></ol></nav></div></div><div class=content id=content data-end-flag=（本文完）><div class="details admonition abstract open"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-clipboard-list" aria-hidden=true></i>启动<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>启动是系统的第一个动作。</div></div></div><p>系统在完成堆桟初始化之后，就可以调用 <code>rtthread_startup</code> 函数，完成操作系统启动动作。</p><p><code>rtthread_startup</code> 函数内主要操作：</p><ul><li>关闭中断</li><li>初始化必要的片上驱动</li><li>初始化系统定时器</li><li>初始化系统调动器</li><li>初始化信号，如果使用了的话</li><li>创建第一个应用线程</li><li>创建定时器线程</li><li>创建空闲线程</li><li>加锁CPU锁</li></ul><p>最后启动调度器，在调度器内启动第一个线程(一般为<code>main</code>线程)，并且永远都不会返回。</p><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-circle-info" aria-hidden=true></i>信息<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>为啥不会返回呢？因为完成调度之后，就跳转到第一个线程上执行，且后续会在各个线程中跳转，无法返回调度器函数。</div></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>void</span> <span class=nf>rt_system_scheduler_start</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>rt_thread</span> <span class=o>*</span><span class=n>to_thread</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>rt_ubase_t</span> <span class=n>highest_ready_priority</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * legacy rt_cpus_lock. some bsp codes still use it as for it&#39;s critical
</span></span></span><span class=line><span class=cl><span class=cm>     * region. Since scheduler is never touching this, here we just release it
</span></span></span><span class=line><span class=cl><span class=cm>     * on the entry.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>     <span class=c1>// 主动释放掉 `cpus` 锁，防止前面使用过忘记释放。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>rt_hw_spin_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_cpus_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* ISR will corrupt the coherency of running frame */</span>
</span></span><span class=line><span class=cl>    <span class=nf>rt_hw_local_irq_disable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * for the accessing of the scheduler context. Noted that we don&#39;t have
</span></span></span><span class=line><span class=cl><span class=cm>     * current_thread at this point
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>     <span class=c1>// 加锁调度器。
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=c1>// 我们还没有完成调度器初始化，所以无法使用多核调度，也就不能让其他核心使用调度器。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>_fast_spin_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_mp_scheduler_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* get the thread scheduling to */</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取当前就绪列表中优先级最高的任务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 任务在执行 `rt_thread_startup` 之后，就已经加入就绪列表中。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 一般在启动调度器之前，只会初始化个别系统任务。如：主任务、空闲任务、软件定时器任务。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>to_thread</span> <span class=o>=</span> <span class=nf>_scheduler_get_highest_priority_thread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>highest_ready_priority</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 最高任务不能为空，这个很好解释，如果将要跳转的先成为空，那应该向哪里跳转呢。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>RT_ASSERT</span><span class=p>(</span><span class=n>to_thread</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* to_thread is picked to running on current core, so remove it from ready queue */</span>
</span></span><span class=line><span class=cl>    <span class=c1>// todo:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>_sched_remove_thread_locked</span><span class=p>(</span><span class=n>to_thread</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* dedigate current core to `to_thread` */</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 重新设置第一个线程的核心为启动核，当然启动核心也非必须是ID为0的核心
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 需要考虑一个问题，除了主线程在调度器启动之后立即执行，其余线程，如空闲线程，软件定时器线程是否永远被启动核绑定并执行？
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>RT_SCHED_CTX</span><span class=p>(</span><span class=n>to_thread</span><span class=p>).</span><span class=n>oncpu</span> <span class=o>=</span> <span class=nf>rt_hw_cpu_id</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>RT_SCHED_CTX</span><span class=p>(</span><span class=n>to_thread</span><span class=p>).</span><span class=n>stat</span> <span class=o>=</span> <span class=n>RT_THREAD_RUNNING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>LOG_D</span><span class=p>(</span><span class=s>&#34;[cpu#%d] switch to priority#%d thread:%.*s(sp:0x%08x)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nf>rt_hw_cpu_id</span><span class=p>(),</span> <span class=nf>RT_SCHED_PRIV</span><span class=p>(</span><span class=n>to_thread</span><span class=p>).</span><span class=n>current_priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>RT_NAME_MAX</span><span class=p>,</span> <span class=n>to_thread</span><span class=o>-&gt;</span><span class=n>parent</span><span class=p>.</span><span class=n>name</span><span class=p>,</span> <span class=n>to_thread</span><span class=o>-&gt;</span><span class=n>sp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>_fast_spin_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_mp_scheduler_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* switch to new thread */</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 切换到第一个任务，需要了解的是，第一次切换，不需要 from 线程，也就是说，只需要知道跳转地址就行。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>rt_hw_context_switch_to</span><span class=p>((</span><span class=kt>rt_ubase_t</span><span class=p>)</span><span class=o>&amp;</span><span class=n>to_thread</span><span class=o>-&gt;</span><span class=n>sp</span><span class=p>,</span> <span class=n>to_thread</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* never come back */</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 永远不会执行到这里
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 建议增加一行代码 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// RT_DEBUG(0);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 这样在启动失败之后，可以非常迅速定位到问题
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-circle-info" aria-hidden=true></i>信息<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>软件定时器会直接绑定到启动核心，但是空闲任务是每个核心都会执行，所以不需要特别关心。</div></div></div><h2 id=切换上下文 class=heading-element><span>1 切换上下文</span>
<a href=#%e5%88%87%e6%8d%a2%e4%b8%8a%e4%b8%8b%e6%96%87 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>提到任务切换，跨不过去的一道坎就是上下文切换。把操作系统比作整个人体的话，系统定时器就是心脏，调度器就是大脑，决定下一个可执行哪个任务，而上下文切换就是记忆体，来保存上个动作和恢复当前动作。</p><p>每个处理器对待现场的处理都是不一样的。例如 <code>ARM</code> 处理器需要使用汇编语句一次保存通用寄存器和状态寄存器。而 <code>TriCore</code> 核心有自己的上下文保存区域，简称 <code>CSA(Content Savee Area)</code>。</p><h3 id=csa class=heading-element><span>1.1 CSA</span>
<a href=#csa class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p><code>CSA</code> 是 <code>TriCore</code> 核心的一个特点，在某一个指定的区域按照既定的规则来存储上下文片段，每个片段可以直接将现场保存，可以认为是"快照"，比较容易保存和恢复。每个 <code>CSA</code> 占用空间为 <code>64字节</code>。实际占用空间可以通过设置 <code>CPU_FCX</code> 寄存器初始化第一个 <code>CSA</code> 元素。</p><p>TODO: CSA 教程</p><h3 id=切换上下文-1 class=heading-element><span>1.2 切换上下文</span>
<a href=#%e5%88%87%e6%8d%a2%e4%b8%8a%e4%b8%8b%e6%96%87-1 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>上面提到了每个 <code>CSA</code> 块都可以保存一个现场，其要执行的操作就是从 <code>空闲链表</code> 中申请一块，存储现场之后，在放到上一个被使用的 <code>CSA</code> 块的 <code>NEXT</code> 位置，该位置需要按照规定的公式进行计算得出。同样，恢复现场的时候，需要将当前 <code>CSA</code> 块清空之后，再释放到 <code>空闲链表</code> 中，并设置 <code>FCX</code> 寄存器的值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cm>/* 获取当前线程的 CSA LinkWord */</span>
</span></span><span class=line><span class=cl><span class=n>current_upper_csa</span> <span class=o>=</span> <span class=nf>LINKWORD_TO_ADDRESS</span><span class=p>(</span><span class=nf>__mfcr</span><span class=p>(</span><span class=n>CPU_PCXI</span><span class=p>));</span> <span class=cm>/* 保存当前线程的 CSA 上下文 */</span>
</span></span><span class=line><span class=cl><span class=o>*</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)</span> <span class=n>from</span><span class=p>)</span> <span class=o>=</span> <span class=n>current_upper_csa</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=cm>/* 将 to 线程的 CSA 地址赋值给当前线程的上层上下文的 LinkWord ，用于 TriCore 自动切换线程。*/</span>
</span></span><span class=line><span class=cl><span class=n>current_upper_csa</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)</span> <span class=n>to</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div></div><div class=post-reward><div class=comment>Buy me a coffee~</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=fixed></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2025-02-05 05:07:12">更新于 2025-02-05&nbsp;</span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/b234ee6/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href="https://github.com/yuhanglee/yuhanglee.github.io/blob/main//posts/2024/RT-Thread-%e5%88%86%e6%9e%90/%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b/index.md?plain=1" title=查看源码 target=_blank rel="external nofollow noopener noreferrer" class=link-to-source>查看源码</a></span><span><a href=https://github.com/yuhanglee/yuhanglee.github.io/edit/main//posts/2024/RT-Thread-%e5%88%86%e6%9e%90/%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b/index.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span><span><a href="https://github.com/yuhanglee/yuhanglee.github.io/issues/new?title=[BUG]%20RTT+%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7cRTT+%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F%7c%0A%7cURL%7chttps://yuhanglee.github.io/posts/b234ee6/%7c%0A%7cFilename%7chttps://github.com/yuhanglee/yuhanglee.github.io/blob/main//posts/2024/RT-Thread-%e5%88%86%e6%9e%90/%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b/index.md?plain=1%7c" title=报告问题 target=_blank rel="external nofollow noopener noreferrer" class=link-to-report>报告问题</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=twitter data-url=https://yuhanglee.github.io/posts/b234ee6/ data-title="RTT 启动顺序" data-hashtags=draft><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://yuhanglee.github.io/posts/b234ee6/ data-hashtag=draft><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://yuhanglee.github.io/posts/b234ee6/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://yuhanglee.github.io/posts/b234ee6/ data-title="RTT 启动顺序"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://yuhanglee.github.io/posts/b234ee6/ data-title="RTT 启动顺序"><i data-svg-src=https://unpkg.com/simple-icons@9.19.0/icons/baidu.svg aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/draft/ class=post-tag title="标签 - draft">draft</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/hugo-start/ class=post-nav-item rel=prev title="Hugo Start"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Hugo Start</a><a href=/posts/e3e350c/ class=post-nav-item rel=next title=Zephyr教程-环境配置>Zephyr教程-环境配置<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.143.1"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.17-8b402129"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright order-2" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2024 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/yuhanglee target=_blank rel="external nofollow noopener noreferrer">liyuhang</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="ms-1 d-none">博客已运行</span><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-first"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/yuhanglee/yuhanglee.github.io title="在 GitHub 上查看项目" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:#8581dd;--bg-progress-dark:#fff></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.css><link rel=stylesheet href=https://unpkg.com/pace-js@1.2.4/themes/blue/pace-theme-minimal.css><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.js?features=Array.prototype.fill%2CArray.prototype.find%2CArray.from%2CIntersectionObserver%2CMath.sign%2CObject.assign%2CPromise%2CObject.entries%2Chtml5shiv%2CObject.values%2Cfetch%2CElement.prototype.after"></script><script src=https://unpkg.com/autocomplete.js@0.38.1/dist/autocomplete.min.js defer></script><script src=https://unpkg.com/algoliasearch@4.20.0/dist/algoliasearch-lite.umd.js defer></script><script src=https://unpkg.com/instant.page@5.2.0/instantpage.js async defer type=module></script><script src=https://unpkg.com/sharer.js@0.5.1/sharer.min.js async defer></script><script src=https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.js defer></script><script src=https://unpkg.com/pangu@4.0.7/dist/browser/pangu.min.js defer></script><script src=https://unpkg.com/cell-watermark@1.0.3/src/watermark.min.js defer></script><script src=https://vercount.one/js async defer></script><script src=https://unpkg.com/pace-js@1.2.4/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:50},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,pangu:{enable:!0,selector:"article"},search:{algoliaAppID:"V359M52V1P",algoliaIndex:"hugo",algoliaSearchKey:"9e9413e3f0ea350e8c105a0d97e38486",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},siteTime:"2024-05-01T00:00:00+08:00",version:"v0.3.17-8b402129",watermark:{colspacing:30,content:'<img style="height: 0.85rem;" src="/logo.webp" alt="logo" /> Mask',enable:!0,fontfamily:"MMT_LRH,沐目体",fontsize:1.1,height:20,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script><script async defer data-website-id=4049c0b0-87c9-4573-8ae5-d84449e40e05 src=https://cloud.umami.is/script.js></script></body></html>